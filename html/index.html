<!doctype html>
<html>

<head>
	<meta http-equiv='X-UA-Compatible' content='IE=Edge'>
	<meta name='viewport' content='width=device-width, initial-scale=1'>
	<meta charset='utf-8'>

	<title>extinfo: sauerbraten live monitor</title>
	<meta name='description' content='Sauerbraten live monitor allows you to see server information and player statistics in real-time.'>

	<link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Roboto+Mono:400,700&subset=cyrillic,greek'>
	<link rel='stylesheet' href='/css/style.css'>

	<script src='https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.min.js'></script>
</head>

<body onload='init();' spellcheck='false' class='flex flex-col'>
	<main id='scoreboard' :style='{ background: backgroundImageCSS }'>
		<header>
			<h1 class='scrollable-x'>
				{{info.description}}
			</h1>
			<h3 class='scrollable-x'>
				<strong>{{info.gameMode}}</strong> on <strong>{{info.map}}</strong>
				<br>
				{{formatTimeLeft(info.secsLeft)}} | {{info.masterMode}} | {{info.numberOfClients}}/{{info.maxNumberOfClients}}
			</h3>
		</header>

		<section class='flex flex-row'>
			<player-list v-for='team in teams' :title='`${team.name}: ${team.score}`' :players='team.players'></player-list>
			<player-list v-if='teamless.length > 0' :players='teamless'></player-list>
		</section>

		<section v-show='spectators.length > 0'>
			<h2>spectators</h2>
			<div class='flex flex-row centered'>
				<player-name v-for='spectator in spectators' :player='spectator'></player-name>
			</div>
		</section>
	</main>

	<aside id='serverlist' class='flex flex-col'>
		<h2>Other Servers</h2>
		<div v-if='servers.length' class='scrollable-x'>
			<table>
				<thead>
					<tr>
						<td>Players</td>
						<td>Description</td>
						<td>Mode</td>
						<td>Map</td>
						<td>Time Left</td>
						<td>Master Mode</td>
					</tr>
				</thead>
				<tbody>
					<tr v-for='server in servers'>
						<td class='count'>{{server.numberOfClients}}</td>
						<td>
							<a :href='"#"+server.address' class='subtle'>{{server.description}}</a>
						</td>
						<td>{{server.gameMode}}</td>
						<td>{{server.map}}</td>
						<td class='centered'>{{formatTimeLeft(server.secsLeft)}}</td>
						<td>{{server.masterMode}}</td>
					</tr>
				</tbody>
			</table>
		</div>
		<p v-else class='centered'>
			loading...
		</p>
	</aside>

	<footer class='flex flex-row centered'>
		<small>
			Sauerbraten live monitor by pix.
		</small>
		<small>
			<a href='https://github.com/sauerbraten/extinfo-web'>Code on GitHub</a>
		</small>
	</footer>

	<script src='/js/extinfo.js'></script>

	<script>
		const pad = m => (m < 10 ? '0' : '') + m
		const formatTimeLeft = s => pad(Math.floor(s / 60)) + ':' + pad(s % 60)
		const bgImgOverlayCSS = 'linear-gradient(rgba(0, 0, 0, .3), rgba(0, 0, 0, .3))'
		const bgImgMapshotCSS = map => `url('//sauertracker.net/images/mapshots/${map}.jpg') no-repeat center center / cover`
		const bgImgFallbackCSS = bgImgMapshotCSS('firstevermap')

		const model = {
			info: {
				description: 'loading â€¦',
				gameMode: 'ffa',
				map: 'firstevermap',
				secsLeft: 0,
				masterMode: 'open',
				numberOfClients: 0,
				maxNumberOfClients: 0
			},
			teams: {},
			teamless: [],
			spectators: [],
			servers: []
		}

		Vue.component('player-name', {
			props: {
				player: {
					type: Object,
					default: {
						name: '',
						clientNum: -1,
						privilege: 'none'
					}
				}
			},
			template: `
				<span>
					<span v-if='player.privilege != "none"' :class='"priv-"+player.privilege' :title='player.privilege'>{{player.name}}</span>
					<span v-else>{{player.name}}</span>
					<span class='cn'>({{player.clientNum}})</span>
				</span>`,
		})

		Vue.component('player-list', {
			props: {
				title: {
					type: String,
					default: "players"
				},
				players: {
					type: Array,
					default: []
				}
			},
			template: `
				<div class='team flex flex-col'>
					<h2>{{title}}</h2>
					<div class='team-table scrollable-x'>
						<table>
							<thead>
								<tr>
									<td>Frags</td>
									<td>Deaths</td>
									<td>Accuracy</td>
									<td>Name</td>
								</tr>
							</thead>
							<tbody>
								<tr v-for='player in players'>
									<td class='count'>{{player.frags}}</td>
									<td class='count'>{{player.deaths}}</td>
									<td class='count'>{{player.accuracy}}%</td>
									<td><player-name :player='player'></player-name></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>`,
		})

		new Vue({
			el: '#scoreboard',
			data: model,
			computed: {
				backgroundImageCSS: () => `${bgImgOverlayCSS}, ${bgImgMapshotCSS(model.info.map)}, ${bgImgFallbackCSS}`
			},
			methods: {
				formatTimeLeft: formatTimeLeft
			}
		})

		new Vue({
			el: '#serverlist',
			data: model,
			methods: {
				formatTimeLeft: formatTimeLeft,
				isTeamMode: mode => !(['ffa', 'coop edit', 'instagib', 'efficiency', 'tactics'].includes(mode))
			}
		})
	</script>
</body>

</html>